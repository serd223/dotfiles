# detect platform
# should return 'linux' on any Linux distro and 'darwin' on macOS.
set -g @user_platform "$(uname | tr '[:upper:]' '[:lower:]')"

# fix colors
if-shell -b '[ "#{@user_platform}" = "linux" ]' {
  set-option -g default-command bash
}
if-shell -b '[ "#{@user_platform}" = "darwin" ]' {
  set-option -g default-command zsh
}
set -g default-terminal "xterm-256color"
set-option -sa terminal-features ',xterm-256color:RGB'
set-option -g default-terminal "tmux-256color"
set-option -ga terminal-features ",xterm-256color:usstyle"

# prefix
set -g prefix C-x

# disable escape delay
set -s escape-time 0

# enable mouse scrolling
set -g mouse on

# reload config file
bind r source-file "~/.tmux.conf"

# rename session prompt
bind C-r command-prompt -I "#S" "rename-session '%%'"

# new session prompt
bind C-n command-prompt -I "#S" "new-session -d -s '%%'"

# kill session popup
bind C-u display-popup \
  -w 50% \
  -h 50% \
  -E "tmux list-sessions -F '#{session_name}' | grep -v \"$(tmux display-message -p '#S')\" | fzf --reverse --bind 'tab:toggle+down' --bind 'shift-tab:toggle+up' | xargs -r tmux kill-session -t"

# vim bindings for resizing
bind -r C-h resize-pane -L 1
bind -r C-j resize-pane -D 1
bind -r C-k resize-pane -U 1
bind -r C-l resize-pane -R 1

# vim bindings for splitting window
# L is bound to switching to last client so I changed that to H (for history)
unbind L
bind H switch-client -l
unbind \"
unbind %
bind L split-window -h
bind J split-window -v

# from [https://github.com/ericmckevitt/Dotfiles/blob/main/tmux.conf] (with some modifications) <start>

# implement vim motions for pane movement
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

##### Display Popups ##### 

# lazygit popup
bind C-g display-popup \
  -d "#{pane_current_path}" \
  -w 80% \
  -h 80% \
  -E "lazygit"

# list sessions popup
bind C-b display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse --bind 'tab:toggle+down' --bind 'shift-tab:toggle+up' | xargs -r tmux switch-client -t"

# terminal popup
bind C-t display-message "Unknown platform: #{@user_platform}"
if-shell -b '[ "#{@user_platform}" = "linux" ]' {
  unbind C-t
  bind C-t display-popup \
    -d "#{pane_current_path}" \
    -w 80% \
    -h 80% \
    -E "bash -i -c 'rc;tmux display-message -p \"#{pane_current_path}\" | cd; exec bash'"
  # `rc` is a special alias I have that just sets the cursor to a bar shape
}
if-shell -b '[ "#{@user_platform}" = "darwin" ]' {
  unbind C-t
  bind C-t display-popup \
    -d "#{pane_current_path}" \
    -w 80% \
    -h 80% \
    -E "zsh"
}

##### Display Menu #####
# dotfiles menu
bind C-f display-message "Unknown platform: #{@user_platform}"
bind C-d display-message "Unknown platform: #{@user_platform}"
if-shell -b '[ "#{@user_platform}" = "linux" ]' {
  unbind C-f
  unbind C-d
  bind C-f send-keys "source ~/.bashrc && tmux source-file ~/.tmux.conf" Enter
  bind C-d display-menu -T "#[align=centre]Dotfiles" -x C -y C \
    ".bashrc"           b  "display-popup -w 80% -h 80% -E 'hx ~/dotfiles/bash/.bashrc'" \
    ".bash_aliases"     a  "display-popup -w 80% -h 80% -E 'hx ~/dotfiles/bash/.bash_aliases'" \
    ".tmux.conf"        t  "display-popup -w 80% -h 80% -E 'hx ~/dotfiles/tmux/.tmux.conf'" \
    "languages.toml"    l  "display-popup -w 80% -h 80% -E 'hx ~/dotfiles/helix/languages.toml'" \
    "walked.toml"       w  "display-popup -w 80% -h 80% -E 'hx ~/dotfiles/walked/walked.toml'" \
    "Install"           i  "run-shell '~/dotfiles/install.sh'"\
    "Exit"              q  ""
}
if-shell -b '[ "#{@user_platform}" = "darwin" ]' {
  unbind C-f
  unbind C-d
  bind C-f send-keys "source ~/.zshenv && source ~/.zshrc && tmux source-file ~/.tmux.conf" Enter
  # use 'zsh -lic' here so 'hx' can be found after evaluating '.zshenv' and '.zshrc' with the 'l' and 'i' options that force a full login
  bind C-d display-menu -T "#[align=centre]Dotfiles" -x C -y C \
    ".zshenv"           e  "display-popup -w 80% -h 80% -E 'zsh -lic \"hx ~/dotfiles/zsh/.zshenv\"'" \
    ".zshrc"            z  "display-popup -w 80% -h 80% -E 'zsh -lic \"hx ~/dotfiles/zsh/.zshrc\"'" \
    ".tmux.conf"        t  "display-popup -w 80% -h 80% -E 'zsh -lic \"hx ~/dotfiles/tmux/.tmux.conf\"'" \
    "languages.toml"    l  "display-popup -w 80% -h 80% -E 'zsh -lic \"hx ~/dotfiles/helix/languages.toml\"'" \
    "walked.toml"       w  "display-popup -w 80% -h 80% -E 'zsh -lic \"hx ~/dotfiles/walked/walked.toml\"'" \
    "Install"           i  "run-shell '~/dotfiles/install_macos.sh'"\
    "Exit"              q  ""
}
# </end>
